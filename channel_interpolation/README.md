# Channel Interpolation for DAS Data

This folder contains tools and data for interpolating DAS (Distributed Acoustic Sensing) channel positions along wellbore trajectories and implementing seismic event backprojection for the Utah FORGE geothermal field monitoring system.

## 1. Overview

The channel interpolation module is a critical component of the FORGE DAS downsampling project that enables precise spatial positioning of DAS sensors along curved wellbore trajectories. This is essential for accurate seismic event analysis, wave propagation studies, and arrival time computation.

### Key Capabilities

- **Wellbore Trajectory Processing**: Load and process directional survey data from industry-standard Excel (.csv) formats
- **DAS Channel Position Interpolation**: Use cubic spline interpolation to calculate precise 3D coordinates for each DAS sensor
- **Seismic Event Backprojection**: Calculate theoretical P and S wave arrival times at each DAS channel
- **Interactive Visualization**: Generate 2D and 3D plots for trajectory validation and seismic analysis
- **Multi-format Data Support**: Handle survey data from different sources and coordinate systems

## 2. Files and Structure

### 2.1. Core Analysis Notebook

- **`channel_interpolation.ipynb`** - Main Jupyter notebook containing the complete workflow for DAS channel interpolation and seismic backprojection

### 2.2. Input Data

In this section we describe the main data components (folders, files and their uses in the project) of the workflow contained in the /channel_interpolation directory. These files serve as the input data for the **channel_interpolation.ipynb** notebook, which processes them to generate channel locations, perform backprojection, and produce related outputs.

#### 2.2.1. Well Survey Data

- **`16B(78)-32 Well Survey/`** - Official directional survey data for Well 16B
  - `16B(78)-32 Final Survey Report.xlsx` - Primary survey data file with trajectory coordinates
  - `16B(78)-32 Final Survey Report.pdf` - PDF documentation of survey results
  - `16B(78)-32 Final Survey Report - Geographic.pdf` - Geographic coordinate version
  - `16B(78)-32 Final Final Plot.pdf` - Well trajectory visualization
  - `16B(78)-32 Final Survey Report.txt` - Text format survey data

#### 2.2.2. Anchor Reference Points

- **`anchors/`** - Physical reference points for DAS cable positioning
  - `16Bdas_information_GES_20240330_v1_formated.csv` - Formatted anchor coordinate data
  - `16Bdas.rec` - Raw anchor positioning data

#### 2.2.3. Alternative Survey Data

- **`federica/`** - Additional survey data from different sources
  - `Directional_Survey16A-32.csv` - Well 16A directional survey
  - `Directional_Survey16B-32.csv` - Well 16B directional survey
  - `DirSurvey16A.txt` - Text format survey for Well 16A
  - `DirSurvey16B.txt` - Text format survey for Well 16B
  - `well16A_trajectory.csv` - Processed trajectory for Well 16A
  - `well16B_trajectory.csv` - Processed trajectory for Well 16B

### 2.3. Output Data

This section describes the output files generated by the **channel_interpolation.ipynb** notebook.

#### 2.3.1. Interpolated DAS Positions

- **`interpolated_das_positions_cubic_1496.csv`** - **Primary output**: 1496 DAS channel positions using cubic spline interpolation. The csv contains Measured Depth, Easting, Northing and True Vertical Depth as columns.

## 3. Technical Specifications

This section contains some specifications of the workflow.

### 3.1. DAS System Configuration

- **Total Channels**: 1,496 DAS sensing points
- **Channel Spacing**: 1.021095 meters (3.35 feet)
- **Starting Depth**: 5,369.35 feet (1,636.23 meters) measured depth
- **Cable Length**: ~1.53 km along wellbore trajectory

### 3.2. Coordinate Systems

- **Input**: Feet (US drilling industry standard)
- **Output**: Meters
- **Reference**: UTM coordinates with wellhead origin
- **Wellhead Location (global coordinates)**:
  - Easting: 1,097,907.09 feet (334,655.43 m)
  - Northing: 13,987,765.96 feet (4,263,463.12 m)

### 3.3. Interpolation Methods

- **Interpolation**: Cubic spline interpolation for smooth trajectory representation
- **Validation**: Anchor point comparison for positioning accuracy

## 4. Usage Instructions

### 4.1. Prerequisites

Install required Python packages:

```bash
pip install pandas numpy scipy plotly matplotlib dascore
```

It's easiest to use the dascore environment, whose corresponding requirements.txt file is located in the parent folder of this directory.

```bash
source ~/pyenv/dascore/bin/activate
```

### 4.2. Basic Workflow

1. **Open the Main Notebook**:

   ```bash
   jupyter lab channel_interpolation.ipynb
   ```
2. **Load Survey Data**:
   The notebook automatically loads the well survey data from the Excel file and processes it for interpolation. The only thing needed at this point is to correctly configure the directories that contain the survey reports, anchors, etc.
3. **Configure DAS Parameters**:
   Modify the DAS configuration parameters if needed:

   ```python
   num_channels = 1496
   channel_distance = 1.021095  # meters
   sensor_start_md = 5369.3 * 0.3048  # convert feet to meters
   ```
4. **Run Interpolation**:
   Execute the interpolation cells to generate DAS channel positions.
5. **Visualize Results**:
   The notebook generates interactive 3D and 2D visualizations for quality control.
6. **Seismic Backprojection**:
   Load seismic catalog data and run backprojection analysis. Visualize the P and S wave arrivals on the selected event.

### 4.3. Key Functions

#### `interpolate_das_channel_positions`

This notebook cell performs the core spatial interpolation of DAS channel positions along the wellbore trajectory using cubic spline methods. It takes raw directional survey data containing measured depth (MD), true vertical depth (TVD), and horizontal coordinates (Easting/Northing), then generates precisely positioned coordinates for each of the 1,496 DAS channels at regular 1.021-meter intervals along the wellbore path. The function handles essential preprocessing steps including unit conversions from feet to meters, data cleaning to remove invalid survey entries, and validation against anchor reference points. The cubic spline interpolation preserves the smooth, physical geometry of the wellbore while ensuring that each DAS sensor has accurate 3D coordinates for subsequent seismic analysis. The output includes both the interpolated channel positions and loaded anchor data for validation purposes.

#### `backprojection(catalog_event: pd.DataFrame, cable_channel_locs: dict-like, vp: float, vs: float)`

This function implements the fundamental seismic wave backprojection algorithm that calculates theoretical P-wave and S-wave arrival times at each DAS channel position for a given seismic event. The algorithm extracts the event's origin time and 3D hypocenter location from the seismic catalog, converts relative coordinates to absolute UTM coordinates, and computes the straight-line distance from the event to each of the 1,496 DAS channels using 3D Euclidean geometry. Using site-specific wave velocities (5.821 km/s for P-waves, 3.414 km/s for S-waves), it calculates travel times and generates comprehensive datetime arrays of predicted arrival times. This creates a theoretical framework for validating event detection algorithms, analyzing wave propagation characteristics, and correlating catalog events with observable features in DAS recordings.

```python
p_times, s_times = backprojection(
    catalog_event,
    cable_channel_locs,
    vp, vs
)
```

#### `compute_distance(point1: tuple, point2: tuple)`

This utility function calculates the 3D Euclidean distance between any two spatial points using the extended Pythagorean theorem. In seismic monitoring applications, it specifically computes the straight-line ray path distance between a seismic event's hypocenter and each DAS channel position along the wellbore. The function takes two coordinate tuples (easting, northing, depth) and returns the direct distance in meters, serving as the fundamental input for travel time calculations in the backprojection algorithm. This distance calculation assumes homogeneous media and straight-line wave propagation, providing reasonable accuracy for the small-scale geometry typical of the FORGE monitoring system where distances rarely exceed 2 kilometers.

#### `get_sample_number(pick_time: datetime, patch_min_time: numpy.datetime64, sample_period: numpy.datetime64)`

This function performs the time-to-sample index conversion that enables precise overlay of theoretical wave arrival times onto actual DAS data arrays. It takes a datetime object representing a predicted wave arrival time and converts it to the corresponding integer sample index in the DAS recording by calculating the time difference from the recording start time and dividing by the sampling period. The function maintains nanosecond-precision timing to ensure accurate alignment between theoretical predictions and recorded data. This conversion is essential for creating visualizations that display predicted P and S wave arrivals as scatter points overlaid on strain rate waterfall plots, enabling direct comparison between theory and observation.

#### `plot_tvd_vs_coordinates(df_original: pd.DataFrame, df_interpolated: pd.DataFrame, anchors_df: pd.DataFrame, optional, title_suffix: str, optional)`

This visualization function creates comprehensive 2D cross-sectional views of the wellbore trajectory by plotting True Vertical Depth against horizontal coordinates (Easting and Northing) in separate subplots. The function displays both the original survey points as reference markers and the interpolated DAS channel positions as a dense point cloud, allowing for direct visual comparison and quality assessment of the interpolation results. It incorporates anchor reference points when available, providing validation markers that help verify the accuracy of spatial positioning. The resulting interactive plots use standard geological conventions with depth increasing downward, include detailed hover information, and serve as valuable tools for trajectory analysis, interpolation quality control, and understanding the 3D geometry of the monitoring system.

## 5. Seismic Wave Backprojection and Arrival Time Calculation

This section outlines the method used to estimate the arrival times of P and S waves for each channel in the DAS cable. These computed times serve as pseudo-labels, enabling downstream tasks such as automated phase picking and event analysis.

### 5.1. Physical Principles

Seismic wave backprojection is a fundamental technique in earthquake seismology that calculates when seismic waves generated by an earthquake should arrive at different monitoring locations. When a seismic event occurs at a specific location and time (hypocenter and origin time), it generates both P-waves (primary/compressional waves) and S-waves (secondary/shear waves) that propagate outward through the subsurface at different velocities. P-waves travel faster and arrive first, followed by the slower S-waves, creating a characteristic time delay that depends on distance and the velocity structure of the Earth.

### 5.2. Mathematical Foundation

The arrival time calculation is based on the fundamental relationship between distance, velocity, and travel time:

```
Travel_Time = Distance / Velocity
Arrival_Time = Origin_Time + Travel_Time
```

For each DAS channel, the algorithm computes:

1. **3D Distance**: `Distance = √[(Ex - Cx)² + (Ey - Cy)² + (Ez - Cz)²]`

   - Where (Ex, Ey, Ez) = Event coordinates
   - And (Cx, Cy, Cz) = Channel coordinates
2. **Travel Times**:

   - P-wave: `t_p = Distance / 5821 m/s`
   - S-wave: `t_s = Distance / 3414 m/s`
3. **Arrival Times**:

   - P-arrival: `Origin_Time + t_p`
   - S-arrival: `Origin_Time + t_s`

### 5.3. Step-by-Step Process

#### 5.3.1. Event Location Processing

The algorithm begins by extracting seismic event information from the catalog, including the origin time, date, and spatial coordinates. Event locations are typically provided as relative coordinates (X, Y, Depth) measured from the wellhead position in feet. These must be converted to absolute UTM coordinates in meters:

```python
# Convert relative event coordinates to absolute positions
event_easting_abs = wellhead_easting + (event_x_relative * 0.3048)
event_northing_abs = wellhead_northing + (event_y_relative * 0.3048)
event_depth_abs = event_depth * 0.3048
```

#### 5.3.2. Distance Calculation Array

For each of the 1,496 DAS channels, the algorithm computes the 3D straight-line distance from the event hypocenter to the channel position. This assumes that seismic waves travel along direct ray paths through homogeneous media, which is reasonable for the relatively small distances and uniform geology typical at FORGE.

#### 5.3.3. Velocity Model Application

The FORGE site uses a simplified but effective velocity model based on local geological characterization:

- **P-wave velocity**: 5.821 km/s (typical for consolidated sedimentary rocks)
- **S-wave velocity**: 3.414 km/s (approximately 0.59 × Vp, consistent with Poisson's ratio ~0.25)

These velocities represent average values for the geological formations and have been validated through previous seismic studies at the site.

#### 5.3.4. Temporal Precision and Synchronization

The calculation maintains microsecond-level precision throughout the process, which is critical for high-frequency DAS data that typically samples at 4 kHz. The algorithm handles:

- Timezone corrections between UTC and local time
- Microsecond precision in datetime objects
- Temporal alignment between catalog and DAS data

### 5.4. Validation and Quality Control

The calculated arrival times undergo several validation procedures:

1. **Physical Consistency**: S-wave arrivals must occur after P-wave arrivals due to velocity differences
2. **Temporal Range**: All arrivals should fall within reasonable time windows relative to the event origin
3. **Spatial Patterns**: Arrival time variations should logically reflect the geometric relationship between event location and channel positions
4. **Data Correlation**: When overlaid on DAS recordings, theoretical arrivals should align with observable seismic features

### 5.5. Applications and Limitations

#### 5.5.1. Primary Uses

- **Event Detection Validation**: Compare theoretical arrivals with automatic detection algorithms
- **Arrival Time Generation**: Generate arrival times of P and S waves for each event and each channel of the DAS cable, in order to enable downstream tasks such as machine-learning based phase-picking.

#### 5.5.2. Known Limitations

- **Homogeneous Velocity Assumption**: Real geology exhibits velocity variations due to lithology, fracturing, and fluid content
- **Straight-line Ray Paths**: Complex velocity structures can cause ray bending, especially over longer distances
- **Point Source Model**: Assumes events occur at a single point rather than having finite rupture dimensions
- **No Topographic Corrections**: Does not account for surface elevation variations or complex near-surface geology

Despite these limitations, the backprojection method provides valuable first-order estimates that are particularly effective for the FORGE monitoring geometry where distances are relatively short (< 2 km) and the geology is relatively uniform.

## 6. Output File Formats

### 6.1. Interpolated Positions CSV

The primary output file `interpolated_das_positions_cubic_1496.csv` contains:

| Column         | Description                   | Units  |
| -------------- | ----------------------------- | ------ |
| `MD_m`       | Measured depth along wellbore | meters |
| `EASTING_m`  | UTM easting coordinate        | meters |
| `NORTHING_m` | UTM northing coordinate       | meters |
| `TVD_m`      | True vertical depth           | meters |

## 7. Seismic Applications

### 7.1. Wave Velocity Model

Uniform velocity in all directions is assumed.

- **P-wave velocity**: 5.821 km/s (FORGE site characterization)
- **S-wave velocity**: 3.414 km/s (FORGE site characterization)

### 7.2. Backprojection Analysis

The notebook implements seismic wave backprojection that can be used for multiple scientific and operational purposes:

- **Validating Automatic Event Detection**: Compare theoretical wave arrivals with automated detection algorithms to assess their accuracy and identify potential false positives or missed events
- **Arrival Time Calculation**: Use the arrival time framework as a foundation for more sophisticated event location algorithms that can improve upon catalog positions

### 7.3. Visualization Features

- **3D trajectory plots**: Interactive wellbore visualization
- **2D cross-sections**: TVD vs horizontal coordinates
- **Comparative analysis**: Original vs interpolated trajectories
- **DAS overlay plots**: Strain rate data with P and S wave arrival overlays

## 8. Data Quality and Validation

### 8.1. Quality Checks

- Survey data continuity validation
- Interpolation range verification
- Anchor point alignment testing
- Physical constraint validation (monotonic depth increase)

### 8.2. Known Limitations

- Assumes homogeneous velocity model
- Straight-line ray paths (no ray bending)
- Point source approximation for seismic events
- No topographic corrections

## 9. Integration with Main Project

This channel interpolation module integrates with the broader FORGE DAS downsampling project:

1. **Spatial Reference**: Provides precise channel coordinates
2. **Event Analysis**: Enables correlation between DAS data and seismic catalogs
3. **Quality Control**: Validates DAS system geometry for processing workflows
4. **Visualization**: Supports 3D event visualization and analysis

## 10. References and Data Sources

- **Utah FORGE**: Geothermal field DAS monitoring system
- **Well Survey Data**: Official directional drilling reports
- **Velocity Model**: FORGE site characterization studies
- **DAS System**: Distributed acoustic sensing configuration parameters

## 11. Troubleshooting

### 11.1. Common Issues to Look Out For

1. **File Path Errors**: Ensure all input files are in correct subdirectories
2. **Unit Conversion**: Verify feet/meter conversions for coordinate systems
3. **Memory Usage**: Large interpolation datasets may require system optimization
4. **Time Synchronization**: Check UTC/local time handling for seismic data

### 11.2. Support

For technical support or questions about the channel interpolation workflow, refer to the main project documentation or contact the developer.
